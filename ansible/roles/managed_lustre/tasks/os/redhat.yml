---
- name: Install Managed Lustre Client Repo
  ansible.builtin.yum_repository:
    name: "lustre-client-rocky-{{ ansible_distribution_major_version }}"
    description: "Lustre Client"
    baseurl: '{{ managed_lustre_repo_url }}'
    enabled: true
    gpgcheck: false
  become: yes

- name: Temporarily disable kernel exclusion
  ansible.builtin.lineinfile:
    path: /etc/yum.repos.d/rocky.repo
    regexp: '^(exclude=.*kernel.*)$'
    line: '# \1'
    backrefs: true
  register: kernel_exclude
  become: yes

- name: Install Kernel and Lustre Client
  ansible.builtin.dnf:
    name: "{{ ['kernel', 'kernel-devel'] + managed_lustre_packages }}"
    state: present
    update_cache: true
    disablerepo: "*"
    enablerepo: "lustre-client-rocky-{{ ansible_distribution_major_version }},baseos,appstream"
  register: lustre_install
  become: true

- name: Re-enable kernel exclusion
  ansible.builtin.lineinfile:
    path: /etc/yum.repos.d/rocky.repo
    regexp: '^# (exclude=.*kernel.*)$'
    line: '\1'
    backrefs: true
  when: kernel_exclude.changed
  become: yes

- name: Reboot if kernel or lustre was updated
  block:
    - name: Rebooting...
      ansible.builtin.command: /sbin/reboot
      async: 1
      poll: 0

    - name: Wait for system to become reachable after reboot
      ansible.builtin.wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 300
  when: lustre_install.changed
  become: yes
